<?xml version="1.0" encoding="UTF-8"?>
<project name="build-test" default="help-instructions">
	<import file="build-common.xml" />
	<import file="build-javac.xml" />

	<!-- cobertura classpath -->
	<path id="cobertura.classpath">
		<fileset dir="${test.lib.dir}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<!-- junit classpath -->
	<path id="test.classpath">
		<pathelement location="${build.classes.dir}" />
		<pathelement location="${build.test.dir}" />
		<fileset dir="${test.lib.dir}">
			<include name="*.jar" />
		</fileset>
		<fileset dir="${compile.lib.dir}">
			<include name="*.jar" />
		</fileset>
		<fileset dir="${runtime.lib.dir}">
			<include name="*.jar" />
		</fileset>
		<fileset dir="${util.lib.dir}">
			<include name="*.jar" />
		</fileset>
	</path>

	<target name="compile-test" depends="compile">
		<mkdir dir="${build.test.dir}" />
		<javac srcdir="${src.test.dir}" destdir="${build.test.dir}" classpathref="test.classpath" debug="on" target="1.6" source="1.6" includeantruntime="false" />
	</target>

	<!-- 
	  run the junit tests and generate the cobertura reports 
	  -->
	<target name="cobertura" depends="compile-test" description="[build-test] Compile, run and provide coverage for the junit tests">
		<!-- define the cobertura task -->
		<taskdef classpathref="cobertura.classpath" resource="tasks.properties" />

		<mkdir dir="${cobertura.reports.dir}/xml" />
		<mkdir dir="${cobertura.reports.dir}/html" />

		<delete file="cobertura.ser" />

		<cobertura-instrument todir="${build.instrumented.dir}">
			<ignore regex="org.apache.log4j.*" />
			<fileset dir="${build.classes.dir}">
				<include name="**/*.class" />
				<exclude name="**/*Test.class" />
			</fileset>
		</cobertura-instrument>

		<mkdir dir="${junit.reports.dir}/xml" />
		<mkdir dir="${junit.reports.dir}/html" />

		<junit fork="yes" printsummary="yes" haltonfailure="no" failureproperty="junit.failure" showoutput="true">
			<classpath location="${build.instrumented.dir}" />
			<classpath refid="cobertura.classpath" />
			<classpath refid="test.classpath" />

			<batchtest fork="yes" todir="${junit.reports.dir}/xml" >
				<fileset dir="${build.test.dir}">
					<include name="**/*Test.class" />
				</fileset>
			</batchtest>
			<formatter type="xml" />
		</junit>

		<junitreport todir="${junit.reports.dir}/xml">
			<fileset dir="${junit.reports.dir}/xml">
				<include name="TEST-*.xml" />
			</fileset>
			<report todir="${junit.reports.dir}/html" />
		</junitreport>

		<cobertura-report format="xml" destdir="${cobertura.reports.dir}/xml" >
			<fileset dir="${src.java.dir}">
				<include name="**/*.java" />
			</fileset>
		</cobertura-report>

		<cobertura-report format="html" destdir="${cobertura.reports.dir}/html" >
			<fileset dir="${src.java.dir}">
				<include name="**/*.java" />
			</fileset>
		</cobertura-report>
		<fail if="${junit.failure}" message="JUnit Tests Failed!" />
	</target>

	<!-- 
	  run the junit tests only 
	  -->
	<target name="junit" depends="compile-test" description="[build-test] Compile and run the junit tests only">
		<mkdir dir="${junit.reports.dir}/xml" />
		<mkdir dir="${junit.reports.dir}/html" />

		<junit fork="yes" printsummary="yes" haltonfailure="no" failureproperty="junit.failure" showoutput="true">
			<classpath refid="test.classpath" />

			<batchtest fork="yes" todir="${junit.reports.dir}/xml" >
				<fileset dir="${build.test.dir}">
					<include name="**/*Test.class" />
				</fileset>
			</batchtest>
			<formatter type="xml" />
		</junit>

		<junitreport todir="${junit.reports.dir}/xml">
			<fileset dir="${junit.reports.dir}/xml">
				<include name="TEST-*.xml" />
			</fileset>
			<report todir="${junit.reports.dir}/html" />
		</junitreport>
		<fail if="${junit.failure}" message="JUnit Tests Failed!" />
	</target>

	<!--
	  Compile all of the source files, instrument them by cobertura and jar them
	  up
	  -->
	<target name="jar-instrumented" depends="compile" description="[build-test] Compile and build the instrumented classes">
		<!-- define the cobertura task -->
		<taskdef classpathref="cobertura.classpath" resource="tasks.properties" />

		<cobertura-instrument todir="${build.instrumented.dir}">
			<fileset dir="${build.classes.dir}">
				<include name="**/*.class" />
				<exclude name="**/*Test.class" />
			</fileset>
		</cobertura-instrument>

		<!--
		  Now jar up the instrumented classes, properties and all of the rest of
		  the information
		  -->
		<jar destfile="${dist.dir}/${ant.project.name}-instrumented.jar">
			<fileset dir="${build.instrumented.dir}">
				<include name="**/*.class" />
			</fileset>
			<fileset dir="${build.classes.dir}">
				<exclude name="**/*.class" />
			</fileset>
		</jar>
	</target>
</project>
